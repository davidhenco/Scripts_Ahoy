#!/bin/zsh --no-rcs

# Get USB device information
usb_output=$(system_profiler SPUSBHostDataType SPUSBDataType)

# Initialize output
device_list=""

# Parse the output line by line
current_device=""
current_connection=""
current_manufacturer=""
current_serial=""

while IFS= read -r line; do
    # Calculate indentation level
    indent=$(echo "$line" | sed -n 's/^\( *\).*/\1/p' | wc -c)
    
    # Detect device name (line ending with colon, not a property line)
    if [[ $line =~ ^[[:space:]]+[^:]+:[[:space:]]*$ ]] && \
       [[ ! $line =~ (Location ID|Connection Type|Driver|Manufacturer|Serial Number|Link Speed|USB Vendor ID|USB Product ID|USB Product Version|Power Allocated): ]]; then
        
        # Save previous device if it was removable and not filtered
        if [[ -n $current_device ]] && [[ $current_connection == "Removable" ]]; then
            # Exclude devices with "Hub", "LAN", or "Video" in the name
            if [[ ! $current_device =~ (Hub|HUB|LAN|Video) ]]; then
                device_list+="Device: $current_device\n"
                device_list+="Manufacturer: ${current_manufacturer:-Not Available}\n"
                device_list+="Serial Number: ${current_serial:-Not Available}\n"
                device_list+="\n"
            fi
        fi
        
        # Start new device
        current_device=$(echo "$line" | sed -E 's/^[[:space:]]+(.+):[[:space:]]*$/\1/')
        current_connection=""
        current_manufacturer=""
        current_serial=""
    fi
    
    # Parse Connection Type
    if [[ $line =~ Connection\ Type:[[:space:]]*(.+)$ ]]; then
        current_connection=$(echo "${match[1]}" | xargs)
    fi
    
    # Parse Manufacturer
    if [[ $line =~ Manufacturer:[[:space:]]*(.+)$ ]]; then
        current_manufacturer=$(echo "${match[1]}" | xargs)
    fi
    
    # Parse Serial Number
    if [[ $line =~ Serial\ Number:[[:space:]]*(.+)$ ]]; then
        current_serial=$(echo "${match[1]}" | xargs)
    fi
done <<< "$usb_output"

# Check last device
if [[ -n $current_device ]] && [[ $current_connection == "Removable" ]]; then
    # Exclude devices with "Hub", "LAN", or "Video" in the name
    if [[ ! $current_device =~ (Hub|LAN|Video) ]]; then
        device_list+="Device: $current_device\n"
        device_list+="Manufacturer: ${current_manufacturer:-Not Available}\n"
        device_list+="Serial Number: ${current_serial:-Not Available}\n"
    fi
fi

# Remove trailing newlines
device_list=$(echo -e "$device_list" | sed -e :a -e '/^\n*$/{$d;N;ba' -e '}')

# Check if any removable devices were found
if [[ -z $device_list ]]; then
    device_list="No removable USB devices found."
fi

# Copy to clipboard
echo -e "$device_list" | pbcopy
echo "$device_list" 
echo "... copied to clipboard"

# Display in osascript dialog
osascript <<EOF
display dialog "$device_list" & return & return & ¬
        "This information has been successfully copied to your Clipboard. " & ¬
        "Please paste it in the brand/manufacturer field of the request that is about to open." buttons {"OK"} default button "OK" with title "USB Removable Devices" giving up after 60
EOF

exit 0
